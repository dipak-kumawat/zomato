/* Use of this pixel is subject to the Amazon ad specs and policies at http://www.amazon.com/b/?&node=7253015011. Version number: 4, Changeset: Bug fixes and performance improvements for tag template */
this.amzn=this.amzn||{},this.amzn.js=function(){"use strict";var e={nameLength:256,valueLength:1e3,eventNameLengthWarning:"Event name is longer than 256 characters.",parameterNameLengthWarning:"Length of parameter name exceeds 256 characters.",parameterValueLengthWarning:"Length of parameter value exceeds 1000 characters.",parameterKeyLengthWarning:"Length of parameter key exceeds 256 characters.",AIP_TOKEN_COOKIE_NAME:"aatToken",AIP_TOKEN_URL_QUERY_PARAM_NAME:"amznToken",NO_CONSENT_COOKIE_NAME:"AMZN-NoCookieConsent"},t=e;function n(e){this.endpoints=e,this.region="NA",this.stage="PROD",this.tags={},this.tcfv2={}}n.prototype.addTag=function(e,t){var n=null==t?e:t;this.tags[n]=e},n.prototype.getTagIds=function(e){var t=this.tags;return e.map((function(e){return t[e]||e}))},n.prototype.trackEvent=function(e,t,n){this.trackEventWithTags(e,t,n,Object.keys(this.tags))},n.prototype.trackEventWithTags=function(e,n,a,r){var o=this.getPixelEndpoint(this.region,this.stage),s=this.tcfv2;n=n||{},e?o?(a&&(n.ts=a),this.getTagIds(r).forEach((function(a){!function(e,n,a,r,o){var s=document.createElement("iframe"),i=e+"?pid="+n+"&event="+a,c=["gdpr","gdpr_pd","gdpr_consent"],h=[];if(a.length>t.nameLength&&h.push(`${t.eventNameLengthWarning}, ${a}`),Array.isArray(r)?(r.forEach((function(e){Object.keys(e)[0].length>t.nameLength&&h.push(`${t.parameterNameLengthWarning}, ${Object.keys(e)[0]}`),e[Object.keys(e)[0]].length>t.valueLength&&h.push(`${t.parameterValueLengthWarning}, ${e[Object.keys(e)[0]]}`)})),i+="&items="+encodeURI(JSON.stringify(r))):r&&Object.keys(r)&&Object.keys(r).filter((function(e){return!c.includes(e)})).forEach((function(e){var n;e.length>t.nameLength&&h.push(`${t.parameterNameLengthWarning}, ${e}`),(n=r[e])||""===n?(n.length>t.valueLength?h.push(`${t.parameterValueLengthWarning}, ${n}`):Object.keys(n)&&Object.keys(n)[0]&&Object.keys(n).forEach((function(e){e.length>t.nameLength&&h.push(`${t.parameterKeyLengthWarning}, ${e}`),n[e].length>t.valueLength&&h.push(`${t.parameterValueLengthWarning}, ${n[e]}`)})),"object"==typeof n&&(n=encodeURI(JSON.stringify(n))),i+="&"+e+"="+n):console.warn("Key "+e+" has no value")})),h.length>0)return console.warn(`Event has ${h.length} validation errors.`),void console.warn(h);if(o&&c.forEach((function(e){o[e]&&(i+="&"+e+"="+o[e])})),document.cookie.indexOf(t.AIP_TOKEN_COOKIE_NAME)>=0){const e=document.cookie.split(";").find((e=>e.trim().startsWith(t.AIP_TOKEN_COOKIE_NAME+"=")));if(void 0!==e){const n=e.substring(e.indexOf("=")+1);i+="&"+t.AIP_TOKEN_URL_QUERY_PARAM_NAME+"="+n}}s.style.display="none",s.setAttribute("src",i),s.setAttribute("id","tag_fire_"+n+"_"+a),document.body.appendChild(s)}(o,a,e,n,s[a])}))):console.warn("No valid endpoint."):console.warn("No event specified.")},n.prototype.trackPixel=function(e,t,n){var a=this,r={};((t=(t=t||"").split("?")).length>1?t[1]:t[0]).split("&").forEach((function(e){var t,n,o=e.split("=");o.length<=1||("ex-fargs"===o[0]?(t=a.parsePixelArgs(o[1],"&"),r.fargs_id=t.id,r.fargs_type=t.type):"ex-hargs"===o[0]&&(n=a.parsePixelArgs(o[1],";"),r.hargs_c=n.c,r.hargs_p=n.p))})),this.validatePixelData(r),Object.keys(r).forEach((function(e){r[e]||delete r[e]})),this.trackEvent(e,r,n)},n.prototype.addTcfv2=function(e){this.addTcfv2WithTags(e,Object.keys(this.tags))},n.prototype.addTcfv2WithTags=function(e,t){var n=this.tcfv2;this.getTagIds(t).forEach((function(t){n[t]=e}))},n.prototype.getPixelEndpoint=function(e,t){var n,a=this.endpoints[e];return""===a||null==a?(console.warn("Endpoint does not exist, please check your region configuration!"),null):""===(n=a[t])||null==n?(console.warn("Endpoint does not exist, please check your stage configuration!"),null):n},n.prototype.parsePixelArgs=function(e,t){var n=decodeURIComponent(e),a={};return(n=n.replace(/\?/g,"")).split(t).forEach((function(e){(e=e.split("=")).length>1&&(a[e[0]]=e[1])})),a},n.prototype.validatePixelData=function(e){var t=e.hargs_c&&e.hargs_p,n=e.fargs_id&&e.fargs_type;t||n||console.warn("Invalid arguments for a trackPixel event, please check your implementation!")},n.prototype.setRegion=function(e){this.region=e},n.prototype.setStage=function(e){this.stage=e};var a=n;function r(e,t,n){this.eventTracker=e,this.setUserDataHandler=t,this.aatEventsQueue=[],this.isSetUserDataInProcess=!1}r.prototype.proccessCommandQueue=function(e){var t=this;(e||[]).forEach((function(e){t.proccessCommand(e[0],e[1])}))},r.prototype.proccessCommand=function(e,t){var n=Array.prototype.slice.call(e),a=e[0];switch(t=t||(new Date).getTime(),a.toUpperCase()){case"TRACKEVENT":this.trackEvent(n,t);break;case"TRACKPIXEL":this.trackPixel(n,t);break;case"PIXEL":case"WITHTAG":this.withTag(n,t);break;case"ADDPIXEL":case"ADDTAG":this.addTag(n);break;case"ADDTCFV2":this.addTcfv2(n);break;case"SETREGION":this.setRegion(n);break;case"SETSTAGE":this.setStage(n);break;case"SETUSERDATA":this.setUserData(n);break;default:console.warn('Unsupported tag command "'+a+'"')}},r.prototype.setUserData=async function(e){this.isSetUserDataInProcess=!0,this.setUserDataHandler.setUserData(e).then((()=>{this.isSetUserDataInProcess=!1,this.processAatEventsQueue()}))},r.prototype.processAatEventsQueue=function(){if(this.aatEventsQueue.length)for(;this.aatEventsQueue.length;)try{const{argumentArray:e,timestamp:t,tagLabel:n}=this.aatEventsQueue.pop();this.trackEvent(e,t,n)}catch(e){console.warn(e)}},r.prototype.trackEvent=function(e,t,n){if(this.isSetUserDataInProcess)return void this.aatEventsQueue.unshift({argumentArray:e,timestamp:t,tagLabel:n});const a=e[1],r=e[2];void 0!==n?this.eventTracker.trackEventWithTags(a,r,t,[n]):this.eventTracker.trackEvent(a,r,t)},r.prototype.trackPixel=function(e,t){this.eventTracker.trackPixel("__pixel__",e[1],t)},r.prototype.withTag=function(e,t){var n=e[1],a=e[2]||"";switch(a.toUpperCase()){case"TRACKEVENT":this.trackEvent(e.slice(2),t,n);break;case"ADDTCFV2":this.addTcfv2(e.slice(2),n);break;default:console.warn('Unsupported command "'+a+'" used after "withTag" command')}},r.prototype.addTag=function(e){var t=e[2],n=e[1];this.eventTracker.addTag(n,t)},r.prototype.addTcfv2=function(e,t){var n=e[1];void 0!==t?this.eventTracker.addTcfv2WithTags(n,[t]):this.eventTracker.addTcfv2(n)},r.prototype.setRegion=function(e){var t=e[1].toUpperCase();this.eventTracker.setRegion(t)},r.prototype.setStage=function(e){var t=e[1].toUpperCase();this.eventTracker.setStage(t)};var o=r,s=e;const i="AIPToken",c="cookieExpiry",h={method:"POST",mode:"cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer-when-downgrade"};function p(){}p.prototype.formatRequestBody=function(e){const t={};if(null!==e.gdpr&&(t.gdpr=e.gdpr.enabled?1:0,null!==e.gdpr.consent&&(t.gdprConsent=e.gdpr.consent)),null===e.hashedRecords)throw Error("hashedRecords array is null");if(0===e.hashedRecords.length)throw Error("hashedRecords array is empty");return t.hashedRecords=e.hashedRecords,null!==e.ttl&&(t.ttl=e.ttl),t},p.prototype.requestToken=async function(e){const t={...h,body:JSON.stringify(e)},n=await fetch("https://tk.amazon-adsystem.com/envelope",t);if(n.ok){return await n.json()}const a=await n.text();throw Error(a)},p.prototype.isCookiePresent=function(e){return void 0!==document.cookie.split(";").find((t=>t.trim().startsWith(e+"=")))},p.prototype.writeCookie=function(e,t,n){const a=new Date(n).toUTCString();document.cookie=`${e}=${t}; expires=${a}; SameSite=Strict; secure=true;`},p.prototype.renewToken=async function(e){if(!this.isCookiePresent(s.AIP_TOKEN_COOKIE_NAME)&&!this.isCookiePresent(s.NO_CONSENT_COOKIE_NAME))try{const t=this.formatRequestBody(e),n=await this.requestToken(t);return""===n[i]?this.writeCookie(s.NO_CONSENT_COOKIE_NAME,n[i],n[c]):this.writeCookie(s.AIP_TOKEN_COOKIE_NAME,n[i],n[c]),n}catch(e){console.error(e)}},p.prototype.deleteToken=async function(){this.isCookiePresent(s.AIP_TOKEN_COOKIE_NAME)&&this.writeCookie(s.AIP_TOKEN_COOKIE_NAME,"0",1),this.isCookiePresent(s.NO_CONSENT_COOKIE_NAME)&&this.writeCookie(s.NO_CONSENT_COOKIE_NAME,"0",1)},p.prototype.updateToken=async function(e){return await this.deleteToken(),await this.renewToken(e)};var d=p;function u(e){this.tokenHandler=e}u.prototype.setUserData=async function(e){const t={gdpr:{enabled:!1,consent:""},hashedRecords:[],ttl:9600};var n=e[1];n.gdpr&&(t.gdpr=n.gdpr),n.ttl&&(t.ttl=n.ttl);const a=new RegExp("\\b[A-Fa-f0-9]{64}\\b");if(null!=(r=n.email)&&"string"==typeof r&&r.length>0){const e={type:"email",record:""};n.email=n.email.trim().toLowerCase(),a.test(n.email)?e.record=n.email:await async function(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}(n.email).then((t=>{e.record=t})),t.hashedRecords.push(e)}var r;if(t.hashedRecords.length>0)return await this.tokenHandler.updateToken(t)};const g=a,l=o,f=d,m=u,E={NA:{TEST:"https://s.amazon-adsystem.com/iu3",BETA:"https://s-beta.amazon-adsystem.com/iu3",GAMMA:"https://s-preprod.amazon-adsystem.com/iu3",PROD:"https://s.amazon-adsystem.com/iu3"},EU:{BETA:"",GAMMA:"",PROD:"https://aax-eu.amazon-adsystem.com/s/iu3"},FE:{BETA:"",GAMMA:"",PROD:"https://aax-fe.amazon-adsystem.com/s/iu3"}};return function(){const e=new g(E),t=new f,n=new m(t);let a=new l(e,n);window.amzn&&window.amzn.q&&a.proccessCommandQueue(window.amzn.q),window.amzn=function(){a.proccessCommand(arguments)},window.renewToken=function(e){t.renewToken(e)},window.updateToken=function(e){t.updateToken(e)},window.deleteToken=function(){t.deleteToken()}}(),{}}();
